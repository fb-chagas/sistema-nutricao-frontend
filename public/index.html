<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sistema_nutricao_frontend</title>
</head>
<body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Modais do Sistema -->
    <div id="modals-container">
        <!-- Modal Nova NFe -->
        <div id="modal-nova-nfe" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">Nova NFe</h2>
                    <span class="close" onclick="fecharModal('modal-nova-nfe')" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                </div>
                <form id="form-nova-nfe" onsubmit="salvarNFe(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Número da NFe *</label>
                        <input type="text" id="numero-nfe" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Fornecedor *</label>
                        <select id="fornecedor-nfe" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Selecione um fornecedor</option>
                            <option value="1">Distribuidora Alimentos ABC</option>
                            <option value="2">Hortifruti Express</option>
                            <option value="3">Laticínios Qualidade</option>
                            <option value="4">Carnes Premium</option>
                            <option value="5">Grãos & Cereais Ltda</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data de Emissão *</label>
                        <input type="date" id="data-emissao" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Valor Total *</label>
                        <input type="number" id="valor-total" step="0.01" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Observações</label>
                        <textarea id="observacoes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="fecharModal('modal-nova-nfe')" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
                        <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar NFe</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Novo Fornecedor -->
        <div id="modal-novo-fornecedor" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">Novo Fornecedor</h2>
                    <span class="close" onclick="fecharModal('modal-novo-fornecedor')" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                </div>
                <form id="form-novo-fornecedor" onsubmit="salvarFornecedor(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome/Razão Social *</label>
                        <input type="text" id="nome-fornecedor" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">CNPJ *</label>
                        <input type="text" id="cnpj-fornecedor" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="00.000.000/0000-00">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                        <input type="email" id="email-fornecedor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone</label>
                        <input type="text" id="telefone-fornecedor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="(00) 00000-0000">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Endereço</label>
                        <textarea id="endereco-fornecedor" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="fecharModal('modal-novo-fornecedor')" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
                        <button type="submit" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar Fornecedor</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Novo Insumo -->
        <div id="modal-novo-insumo" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">Novo Insumo</h2>
                    <span class="close" onclick="fecharModal('modal-novo-insumo')" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                </div>
                <form id="form-novo-insumo" onsubmit="salvarInsumo(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome do Insumo *</label>
                        <input type="text" id="nome-insumo" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Categoria *</label>
                        <select id="categoria-insumo" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Selecione uma categoria</option>
                            <option value="carnes">Carnes</option>
                            <option value="vegetais">Vegetais</option>
                            <option value="frutas">Frutas</option>
                            <option value="laticinios">Laticínios</option>
                            <option value="graos">Grãos e Cereais</option>
                            <option value="temperos">Temperos</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Unidade de Medida *</label>
                        <select id="unidade-insumo" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Selecione a unidade</option>
                            <option value="kg">Quilograma (kg)</option>
                            <option value="g">Grama (g)</option>
                            <option value="l">Litro (l)</option>
                            <option value="ml">Mililitro (ml)</option>
                            <option value="un">Unidade (un)</option>
                            <option value="cx">Caixa (cx)</option>
                            <option value="pc">Pacote (pc)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Preço Unitário</label>
                        <input type="number" id="preco-insumo" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Descrição</label>
                        <textarea id="descricao-insumo" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="fecharModal('modal-novo-insumo')" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
                        <button type="submit" style="padding: 10px 20px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">Salvar Insumo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts de Integração -->
    <script>
        console.log('Manus helper started');
        
        // Configuração da API
        const API_BASE_URL = 'https://sistema-nutricao-backend.onrender.com';
        
        // Função para mostrar notificações
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notificacao = document.createElement('div');
            notificacao.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            switch(tipo) {
                case 'success':
                    notificacao.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notificacao.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    notificacao.style.backgroundColor = '#ffc107';
                    notificacao.style.color = '#000';
                    break;
                default:
                    notificacao.style.backgroundColor = '#17a2b8';
            }
            
            notificacao.textContent = mensagem;
            document.body.appendChild(notificacao);
            
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.parentNode.removeChild(notificacao);
                }
            }, 5000);
        }
        
        // Função para fazer requisições à API
        async function fazerRequisicaoAPI(endpoint, opcoes = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...opcoes.headers
                },
                ...opcoes
            };
            
            try {
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Erro na requisição API:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    mostrarNotificacao('Backend hibernando... Aguarde até 50 segundos', 'warning');
                } else {
                    mostrarNotificacao(`Erro: ${error.message}`, 'error');
                }
                
                throw error;
            }
        }
        
        // Função para abrir modal
        function abrirModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                console.log(`Modal ${modalId} aberto`);
            } else {
                console.error(`Modal ${modalId} não encontrado`);
                mostrarNotificacao('Erro ao abrir formulário', 'error');
            }
        }
        
        // Função para fechar modal
        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Limpar formulário
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        }
        
        // Função para salvar NFe
        async function salvarNFe(event) {
            event.preventDefault();
            
            const dados = {
                numero: document.getElementById('numero-nfe').value,
                fornecedor_id: document.getElementById('fornecedor-nfe').value,
                data_emissao: document.getElementById('data-emissao').value,
                valor_total: parseFloat(document.getElementById('valor-total').value),
                observacoes: document.getElementById('observacoes').value
            };
            
            try {
                mostrarNotificacao('Salvando NFe...', 'info');
                const resultado = await fazerRequisicaoAPI('/api/nfe', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                
                mostrarNotificacao('NFe salva com sucesso!', 'success');
                fecharModal('modal-nova-nfe');
                
                // Recarregar lista se estiver na página de NFe
                if (window.location.pathname.includes('cadastro-nfe')) {
                    setTimeout(() => window.location.reload(), 1000);
                }
                
            } catch (error) {
                console.error('Erro ao salvar NFe:', error);
            }
        }
        
        // Função para salvar Fornecedor
        async function salvarFornecedor(event) {
            event.preventDefault();
            
            const dados = {
                nome: document.getElementById('nome-fornecedor').value,
                cnpj: document.getElementById('cnpj-fornecedor').value,
                email: document.getElementById('email-fornecedor').value,
                telefone: document.getElementById('telefone-fornecedor').value,
                endereco: document.getElementById('endereco-fornecedor').value
            };
            
            try {
                mostrarNotificacao('Salvando fornecedor...', 'info');
                const resultado = await fazerRequisicaoAPI('/api/fornecedores', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                
                mostrarNotificacao('Fornecedor salvo com sucesso!', 'success');
                fecharModal('modal-novo-fornecedor');
                
            } catch (error) {
                console.error('Erro ao salvar fornecedor:', error);
            }
        }
        
        // Função para salvar Insumo
        async function salvarInsumo(event) {
            event.preventDefault();
            
            const dados = {
                nome: document.getElementById('nome-insumo').value,
                categoria: document.getElementById('categoria-insumo').value,
                unidade: document.getElementById('unidade-insumo').value,
                preco_unitario: parseFloat(document.getElementById('preco-insumo').value) || 0,
                descricao: document.getElementById('descricao-insumo').value
            };
            
            try {
                mostrarNotificacao('Salvando insumo...', 'info');
                const resultado = await fazerRequisicaoAPI('/api/insumos', {
                    method: 'POST',
                    body: JSON.stringify(dados)
                });
                
                mostrarNotificacao('Insumo salvo com sucesso!', 'success');
                fecharModal('modal-novo-insumo');
                
            } catch (error) {
                console.error('Erro ao salvar insumo:', error);
            }
        }
        
        // Conectar botões aos modais quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, conectando botões...');
            
            // Aguardar um pouco para garantir que o React carregou
            setTimeout(() => {
                // Conectar botão Nova NFe
                const btnNovaNfe = document.querySelector('button[class*="Nova NFe"], button:contains("Nova NFe")');
                if (btnNovaNfe) {
                    btnNovaNfe.addEventListener('click', () => abrirModal('modal-nova-nfe'));
                    console.log('Botão Nova NFe conectado');
                }
                
                // Buscar botões por texto
                const botoes = document.querySelectorAll('button');
                botoes.forEach(botao => {
                    const texto = botao.textContent.trim();
                    
                    if (texto.includes('Nova NFe')) {
                        botao.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            abrirModal('modal-nova-nfe');
                        });
                        console.log('Botão Nova NFe encontrado e conectado');
                    }
                    
                    if (texto.includes('Novo Fornecedor')) {
                        botao.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            abrirModal('modal-novo-fornecedor');
                        });
                        console.log('Botão Novo Fornecedor conectado');
                    }
                    
                    if (texto.includes('Novo Insumo')) {
                        botao.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            abrirModal('modal-novo-insumo');
                        });
                        console.log('Botão Novo Insumo conectado');
                    }
                });
                
                console.log(`Total de botões verificados: ${botoes.length}`);
                
            }, 2000);
        });
        
        // Também tentar conectar quando a página muda (SPA)
        let ultimaUrl = location.href;
        new MutationObserver(() => {
            const urlAtual = location.href;
            if (urlAtual !== ultimaUrl) {
                ultimaUrl = urlAtual;
                console.log('URL mudou, reconectando botões...');
                
                setTimeout(() => {
                    const botoes = document.querySelectorAll('button');
                    botoes.forEach(botao => {
                        const texto = botao.textContent.trim();
                        
                        if (texto.includes('Nova NFe') && !botao.hasAttribute('data-modal-conectado')) {
                            botao.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                abrirModal('modal-nova-nfe');
                            });
                            botao.setAttribute('data-modal-conectado', 'true');
                            console.log('Botão Nova NFe reconectado');
                        }
                    });
                }, 1000);
            }
        }).observe(document, { subtree: true, childList: true });
        
        // Fechar modal clicando fora
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
        
        console.log('Sistema de modais inicializado');
    </script>
</body>
</html>

